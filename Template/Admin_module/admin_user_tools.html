{%extends 'Static/base.html'%}
{% load static %}

{% block title %}Admin User Tools{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_module.css' %}">
{% endblock %}

{% block content %}
<div class="admin-user-tools-container container">
    <h1 class="admin-user-tools-title">Bulk User Import</h1>

    <!-- Quick Actions -->
    <div class="admin-user-tools-card">
        <h3>Quick Actions</h3>
        <div class="admin-user-tools-actions">
            <button type="button" class="btn-election admin-user-tools-btn admin-user-tools-btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="fas fa-user-plus me-1"></i>Create New User
            </button>
            <a href="{% url 'admin_module:admin_dashboard' %}" class="btn-election admin-user-tools-btn admin-user-tools-btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <div class="admin-user-tools-card">
        <h3>Bulk Upload Users (.csv)</h3>
        <p class="admin-user-tools-description" style="margin-bottom: .75rem;">Expected headers:
            <code>username</code>, <code>email</code>, <code>first_name</code>, <code>last_name</code>,
            optional: <code>student_id</code>, <code>department_code</code>, <code>course_code</code>,
            <code>year_level</code>, <code>phone_number</code>, <code>password</code>.
        </p>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div style="display: grid; gap: 0.75rem;">
                <div>
                    {{ form.csv_file.label_tag }}<br>
                    {{ form.csv_file }}
                    {% if form.csv_file.help_text %}<div style="color:#64748b; font-size: 0.9rem;">{{ form.csv_file.help_text }}</div>{% endif %}
                </div>
                <div class="form-check">
                    {{ form.update_existing }} <label class="form-check-label" for="id_update_existing">Update existing users if found</label>
                </div>
                <div class="form-check" style="margin-top:.25rem;">
                    {{ form.overwrite_data }} <label class="form-check-label" for="id_overwrite_data">Overwrite existing data (name, email, student_id, dept, course)</label>
                </div>
                
                <div>
                    <button type="submit" class="btn-election" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: #fff; padding: 0.6rem 1rem; border-radius: 8px; border: none;">Process File</button>
                    <a href="{% url 'admin_module:admin_dashboard' %}" class="btn-election" style="background: #64748b; color: #fff; padding: 0.6rem 1rem; border-radius: 8px; text-decoration: none;">Back</a>
                </div>
            </div>
        </form>
    </div>

    {% if results %}
    <div class="admin-user-tools-card">
        <div class="d-flex justify-content-between align-items-center">
            <h3>Results</h3>
            {% if download_token %}
            <a class="btn-election admin-user-tools-btn admin-user-tools-btn-primary" href="{% url 'voting_module:admin_user_tools_download' download_token %}">Download Credentials CSV</a>
            {% endif %}
        </div>
        <div class="table-responsive">
            <table class="admin-user-tools-table table table-striped">
                <thead>
                    <tr>
                        <th>Row</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>First name</th>
                        <th>Last name</th>
                        <th>Status</th>
                        <th>Password (if new/reset)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in results %}
                    <tr>
                        <td>{{ r.row }}</td>
                        <td>{{ r.username }}</td>
                        <td>{{ r.email }}</td>
                        <td>{{ r.first_name }}</td>
                        <td>{{ r.last_name }}</td>
                        <td>
                            {% if r.status == 'created' %}
                                <span class="badge bg-success">Created</span>
                            {% elif r.status == 'updated' %}
                                <span class="badge bg-primary">Updated</span>
                            {% elif r.status == 'skipped' %}
                                <span class="badge bg-secondary">Skipped</span>
                            {% else %}
                                <span class="badge bg-danger">Error</span>
                            {% endif %}
                        </td>
                        <td class="font-monospace">{{ r.password }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<script>
function getCsrfToken() {
    const el = document.querySelector('[name=csrfmiddlewaretoken]');
    return el ? el.value : '';
}

function openPasswordModal(username, password) {
    const overlay = document.getElementById('pwModal');
    overlay.querySelector('.js-username').textContent = username;
    overlay.querySelector('.js-password').textContent = password;
    overlay.style.display = 'flex';
}

function closePasswordModal() {
    const overlay = document.getElementById('pwModal');
    overlay.style.display = 'none';
}

function copyPassword() {
    const pw = document.querySelector('#pwModal .js-password').textContent;
    navigator.clipboard.writeText(pw).then(() => {
        const btn = document.getElementById('copyPwBtn');
        const old = btn.textContent;
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = old, 1500);
    });
}

function resetPassword(userId, username) {
    if (!confirm('Reset password for ' + username + '?')) return;
    fetch('{% url 'admin_module:reset_user_password' 0 %}'.replace('/0/', '/' + userId + '/'), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            openPasswordModal(data.username, data.password);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(err => alert('Request failed: ' + err));
}
</script>
<!-- Password Modal -->
<div id="pwModal" class="modal-overlay" onclick="if(event.target===this) closePasswordModal();">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="pwModalTitle">
        <div class="modal-header">
            <div class="modal-title" id="pwModalTitle">Password Reset Successful</div>
            <button class="btn btn-secondary" style="padding:6px 10px;" onclick="closePasswordModal()">Close</button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:8px; color:#475569;">User: <strong class="js-username"></strong></div>
            <div class="pw-box">
                <div class="pw-value js-password"></div>
                <button id="copyPwBtn" class="btn btn-primary" onclick="copyPassword()">Copy</button>
            </div>
            <div class="copy-hint">Make sure to securely share and/or store this temporary password.</div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closePasswordModal()">Close</button>
            <button id="copyPwBtnFooter" class="btn btn-primary" onclick="copyPassword()">Copy Password</button>
        </div>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="post" action="{% url 'admin_module:create_user' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Create New User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            A secure password will be automatically generated for this user.
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label"><i class="fas fa-user me-1"></i>Username *</label>
              <input type="text" class="form-control" name="username" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label"><i class="fas fa-envelope me-1"></i>Email *</label>
              <input type="email" class="form-control" name="email" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label"><i class="fas fa-id-card me-1"></i>First Name</label>
              <input type="text" class="form-control" name="first_name">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label"><i class="fas fa-id-card me-1"></i>Last Name</label>
              <input type="text" class="form-control" name="last_name">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label"><i class="fas fa-key me-1"></i>Your Admin Password *</label>
              <input type="password" class="form-control" name="confirm_admin_password" required>
              <small class="form-text text-muted">Required to create the user account</small>
            </div>
            <div class="col-md-6 mb-3">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" name="is_staff" id="createUserStaff">
                <label class="form-check-label" for="createUserStaff">
                  <i class="fas fa-user-shield me-1"></i>Staff Member
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="is_active" id="createUserActive" checked>
                <label class="form-check-label" for="createUserActive">
                  <i class="fas fa-check-circle me-1"></i>Active Account
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-user-plus me-1"></i>Create User
          </button>
        </div>
      </form>
        </div>
    </div>
</div>
{% endblock %}



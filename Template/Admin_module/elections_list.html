{%extends 'Static/base.html'%}
{% load static %}

{% block title %}Elections{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/admin_module.css' %}?v=20251016">
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0 fw-bold text-dark">Elections</h2>
        <div class="d-flex gap-3">
            <button type="button" class="btn btn-ebotar" data-bs-toggle="modal" data-bs-target="#createElectionModal">
                <i class="fas fa-plus me-2"></i>New Election
            </button>
            <a class="btn btn-ebotar" href="{% url 'admin_module:candidate_create' %}">
                <i class="fas fa-user-plus me-2"></i>New Candidate
            </a>
        </div>
    </div>

    <div class="card" style="border-radius: 12px;">
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th style="min-width:150px;">Start</th>
                        <th style="min-width:150px;">End</th>
                        <th>Active</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for e in page_obj %}
                    <tr>
                        <td>
                            <div class="fw-semibold">{{ e.title }}</div>
                            <div class="text-muted small">ID: {{ e.id }}</div>
                        </td>
                        <td>{{ e.start_date|date:'Y-m-d H:i' }}</td>
                        <td>{{ e.end_date|date:'Y-m-d H:i' }}</td>
                        <td>
                            {% if e.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="text-end">
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="button" class="btn btn-ebotar-info"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editElectionModal"
                                        data-edit-url="{% url 'election_module:election_edit' e.id %}"
                                        data-title="{{ e.title|escapejs }}"
                                        data-start-year="{{ e.start_year }}"
                                        data-end-year="{{ e.end_year }}"
                                        data-start="{{ e.start_date|date:'Y-m-d\TH:i' }}"
                                        data-end="{{ e.end_date|date:'Y-m-d\TH:i' }}"
                                        data-active="{{ e.is_active|yesno:'1,0' }}"
                                        data-id="{{ e.id }}">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                                <button type="button" class="btn btn-ebotar-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteElectionModal"
                                        data-eid="{{ e.id }}"
                                        data-title="{{ e.title|escapejs }}">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center text-muted py-4">No elections yet</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-3">
        <a class="btn btn-ebotar-secondary" href="{% url 'admin_module:admin_dashboard' %}">‚Üê Back to Admin</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/admin_module.js' %}"></script>

<div class="modal fade" id="deleteElectionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'election_module:election_delete' %}">
        {% csrf_token %}
        <input type="hidden" name="election_id" id="deleteElectionId">
        <div class="modal-header"><h5 class="modal-title">Delete Election</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Delete election <strong id="deleteElectionTitle"></strong>?</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ebotar-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-ebotar-danger" type="submit">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="editElectionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" id="editElectionForm">
        {% csrf_token %}
        <input type="hidden" name="election_id" id="editElectionId">
        <div class="modal-header"><h5 class="modal-title">Edit Election</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="form-label">Start Year</label>
              <input class="form-control" type="number" name="start_year" id="editElectionStartYear" min="2020" max="2035">
            </div>
            <div class="col-6">
              <label class="form-label">End Year</label>
              <input class="form-control" type="number" name="end_year" id="editElectionEndYear" min="2021" max="2036">
            </div>
          </div>
          <div class="mb-2 text-muted small">Title: <strong id="computedElectionTitle"></strong> (format: SY 2025-2026)</div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Start</label>
              <input class="form-control" type="datetime-local" name="start_date" id="editElectionStart">
            </div>
            <div class="col-md-6">
              <label class="form-label">End</label>
              <input class="form-control" type="datetime-local" name="end_date" id="editElectionEnd">
            </div>
          </div>
          <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" name="is_active" id="editElectionActive">
              <label class="form-check-label" for="editElectionActive">Active</label>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <div class="d-flex gap-2">
            <form method="post" action="{% url 'election_module:election_pause' %}" id="pauseForm" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="election_id" id="pauseElectionId">
              <button type="submit" class="btn btn-ebotar-warning" id="pauseBtn">Pause</button>
            </form>
            <form method="post" action="{% url 'election_module:election_resume' %}" id="resumeForm" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="election_id" id="resumeElectionId">
              <button type="submit" class="btn btn-ebotar-success" id="resumeBtn">Resume</button>
            </form>
            <form method="post" action="{% url 'election_module:election_end_now' %}" class="d-inline" onsubmit="return confirm('End this election now?');">
              {% csrf_token %}
              <input type="hidden" name="election_id" id="endNowElectionId">
              <button type="submit" class="btn btn-ebotar-danger">End Now</button>
            </form>
          </div>
          <div>
            <button class="btn btn-ebotar-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-ebotar-primary" type="submit">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Election modal handlers loaded from admin_module.js -->

<!-- Create Election Modal -->
<div class="modal fade" id="createElectionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" action="{% url 'election_module:election_create' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title">Create Election</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-2">
            <div class="col-6">
              <label class="form-label">Start Year *</label>
              <input class="form-control" type="number" name="start_year" id="createElectionStartYear" min="2020" max="2035" required>
              <small class="text-muted">e.g., 2025 for SY 2025-2026</small>
            </div>
            <div class="col-6">
              <label class="form-label">End Year *</label>
              <input class="form-control" type="number" name="end_year" id="createElectionEndYear" min="2021" max="2036" required>
              <small class="text-muted">e.g., 2026 for SY 2025-2026</small>
            </div>
          </div>
          <div class="mb-2 text-muted small">Title: <strong id="computedCreateTitle"></strong> (format: SY 2025-2026)</div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Start Date & Time *</label>
              <input class="form-control" type="datetime-local" name="start_date" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">End Date & Time *</label>
              <input class="form-control" type="datetime-local" name="end_date" required>
            </div>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" name="is_active" id="createElectionActive">
            <label class="form-check-label" for="createElectionActive">Active</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-ebotar-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-ebotar-primary">Create Election</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create Election modal handlers loaded from admin_module.js -->
{% endblock %}
